---
const WAKA_API_KEY = import.meta.env.WAKA_API_KEY;
const encodedKey = btoa(WAKA_API_KEY);

type WakaTimeStats = {
  languages: Array<{
    name: string;
    percent: number;
  }>;
  human_readable_total: string;
  human_readable_total_including_other_language: string;
  total: number;
};

let stats7Days: WakaTimeStats | null = null;
let statsAllTime: WakaTimeStats | null = null;

try {
  const [res7, resAll] = await Promise.all([
    fetch("https://wakatime.com/api/v1/users/current/stats/last_7_days", {
      headers: { Authorization: `Basic ${encodedKey}` },
    }),
    fetch("https://wakatime.com/api/v1/users/current/stats/all_time", {
      headers: { Authorization: `Basic ${encodedKey}` },
    }),
  ]);

  const [data7, dataAll] = await Promise.all([res7.json(), resAll.json()]);
  stats7Days = data7.data;
  statsAllTime = dataAll.data;
} catch (e) {
  console.error(e);
}
---

<section
  id="wakatime"
  class="snap-start min-h-[100dvh] h-fit md:h-screen relative flex items-center bg-[#050505] light:bg-[#f9fafb] overflow-hidden py-10 md:py-0 transition-colors duration-700"
>
  <div class="container mx-auto px-6 md:px-12 relative z-10">
    <div
      class="opacity-0 translate-y-10 transition-all duration-1000 ease-out"
      data-animate
    >
      <div
        class="flex flex-col md:flex-row md:items-end justify-between gap-4 md:gap-6 mb-8 md:mb-12"
      >
        <div>
          <h2
            data-i18n="stats_title"
            class="text-4xl md:text-7xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-white to-white/40 light:from-gray-900 light:to-gray-400"
          >
            Coding Activity
          </h2>
        </div>

        <div
          class="flex p-1 bg-white/5 light:bg-black/5 border border-white/10 light:border-black/10 rounded-xl backdrop-blur-md w-fit relative z-20"
        >
          <button
            aria-label="Show last 7 days coding activity"
            id="btn-7"
            data-i18n="stats_week_button"
            class="relative z-10 px-3 md:px-4 py-2 rounded-lg text-[10px] md:text-xs font-bold uppercase tracking-widest transition-all bg-white light:bg-gray-900 text-black light:text-white"
            >7 Days</button
          >
          <button
            aria-label="Show all time coding activity"
            id="btn-all"
            data-i18n="stats_all_time_button"
            class="relative z-10 px-3 md:px-4 py-2 rounded-lg text-[10px] md:text-xs font-bold uppercase tracking-widest transition-all text-gray-400 light:text-gray-500 hover:text-white light:hover:text-black"
            >All Time</button
          >
        </div>
      </div>

      <div class="grid grid-cols-1">
        <div
          id="wrap-7"
          class="col-start-1 row-start-1 grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8 transition-all duration-500 z-10 opacity-100 translate-x-0"
        >
          <div
            class="bg-white/5 light:bg-white border border-white/10 light:border-black/5 p-5 md:p-8 rounded-2xl md:rounded-3xl backdrop-blur-xl hover:border-indigo-500/50 light:shadow-xl light:shadow-black/5 transition-all group"
          >
            <p
              data-i18n="stats_week"
              class="text-indigo-400 light:text-indigo-600 font-mono text-[10px] md:text-sm uppercase tracking-widest mb-2 md:mb-4"
            >
              Last 7 Days
            </p>
            <h4
              class="text-4xl md:text-6xl font-black text-white light:text-gray-900 group-hover:scale-105 transition-transform duration-500"
            >
              {stats7Days?.human_readable_total_including_other_language}
            </h4>
            <p
              data-i18n="stats_week_desc"
              class="text-gray-500 light:text-gray-500 text-xs md:text-sm mt-3 md:mt-4 leading-relaxed line-clamp-2 md:line-clamp-none"
            >
              Horas detectadas en la Ãºltima semana.
            </p>
          </div>

          <div
            class="bg-white/5 light:bg-white border border-white/10 light:border-black/5 p-5 md:p-8 rounded-2xl md:rounded-3xl backdrop-blur-xl md:col-span-2 light:shadow-xl light:shadow-black/5"
          >
            <p
              data-i18n="stats_top_languages"
              class="text-purple-400 light:text-purple-600 font-mono text-[10px] md:text-sm uppercase tracking-widest mb-4 md:mb-6"
            >
              Top Languages
            </p>
            <div
              class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 md:gap-y-6"
            >
              {
                stats7Days?.languages
                  .slice(0, 4)
                  .map((lang: { name: string; percent: number }) => (
                    <div>
                      <div class="flex justify-between mb-1.5 text-[10px] md:text-xs uppercase tracking-tighter">
                        <span class="text-white light:text-gray-900 font-bold">
                          {lang.name}
                        </span>
                        <span class="text-gray-400 light:text-gray-500">
                          {lang.percent}%
                        </span>
                      </div>
                      <div class="w-full h-1 md:h-1.5 bg-white/10 light:bg-black/5 rounded-full overflow-hidden">
                        <div
                          class="h-full bg-indigo-500"
                          style={`width: ${lang.percent}%`}
                        />
                      </div>
                    </div>
                  ))
              }
            </div>
          </div>
        </div>

        <div
          id="wrap-all"
          class="col-start-1 row-start-1 grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8 transition-all duration-500 z-0 opacity-0 translate-x-10 pointer-events-none"
        >
          <div
            class="bg-white/5 light:bg-white border border-amber-500/30 light:border-amber-200 p-5 md:p-8 rounded-2xl md:rounded-3xl backdrop-blur-xl light:shadow-xl light:shadow-amber-500/5 group"
          >
            <p
              data-i18n="stats_all_time"
              class="text-amber-400 light:text-amber-600 font-mono text-[10px] md:text-sm uppercase tracking-widest mb-2 md:mb-4"
            >
              Historical Total
            </p>
            <h4
              class="text-4xl md:text-6xl font-black text-white light:text-gray-900 group-hover:scale-105 transition-transform duration-500"
            >
              {statsAllTime?.human_readable_total_including_other_language}
            </h4>
            <p
              data-i18n="stats_all_time_desc"
              class="text-gray-500 light:text-gray-500 text-xs md:text-sm mt-3 md:mt-4 leading-relaxed"
            >
              Toda mi carrera profesional en minutos.
            </p>
          </div>

          <div
            class="bg-white/5 light:bg-white border border-white/10 light:border-black/5 p-5 md:p-8 rounded-2xl md:rounded-3xl backdrop-blur-xl md:col-span-2 light:shadow-xl light:shadow-black/5"
          >
            <p
              data-i18n="stats_mastered"
              class="text-amber-400 light:text-amber-600 font-mono text-[10px] md:text-sm uppercase tracking-widest mb-4 md:mb-6"
            >
              Mastered Stack
            </p>
            <div
              class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 md:gap-y-6"
            >
              {
                statsAllTime?.languages.slice(0, 4).map((lang) => (
                  <div>
                    <div class="flex justify-between mb-1.5 text-[10px] md:text-xs uppercase tracking-tighter">
                      <span class="text-white light:text-gray-900 font-bold">
                        {lang.name}
                      </span>
                      <span class="text-gray-400 light:text-gray-500">
                        {lang.percent}%
                      </span>
                    </div>
                    <div class="w-full h-1 md:h-1.5 bg-white/10 light:bg-black/5 rounded-full overflow-hidden">
                      <div
                        class="h-full bg-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.5)] light:shadow-none"
                        style={`width: ${lang.percent}%`}
                      />
                    </div>
                  </div>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <div
        class="mt-8 md:mt-16 flex items-center justify-between border-t border-white/5 light:border-black/5 pt-6 md:pt-8 text-[8px] md:text-[10px] text-gray-500 light:text-gray-400 font-mono uppercase tracking-[0.2em] md:tracking-[0.4em]"
      >
        <div class="flex items-center gap-2">
          <span class="w-1 md:w-1.5 h-1 md:h-1.5 bg-indigo-500 rounded-full"
          ></span>
          <span>WakaTime Engine</span>
        </div>
        <div
          class="flex items-center gap-2 md:gap-4 bg-white/5 light:bg-black/5 px-3 py-1.5 md:px-4 md:py-2 rounded-full border border-white/10 light:border-black/10"
        >
          <span class="text-gray-400 light:text-gray-500"
            >Status: <span class="text-emerald-400 light:text-emerald-600"
              >Online</span
            ></span
          >
          <div class="relative flex h-1.5 md:h-2 w-1.5 md:w-2">
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 light:bg-emerald-600 opacity-75"
            ></span>
            <span
              class="relative inline-flex rounded-full h-1.5 md:h-2 w-1.5 md:w-2 bg-emerald-500"
            ></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    class="absolute -bottom-20 -left-20 w-64 md:w-96 h-64 md:h-96 bg-indigo-600/10 light:bg-indigo-600/5 blur-[100px] md:blur-[150px] rounded-full pointer-events-none theme-perf-target"
  >
  </div>
  <div
    class="absolute -top-20 -right-20 w-64 md:w-96 h-64 md:h-96 bg-purple-600/5 light:bg-purple-600/5 blur-[100px] md:blur-[150px] rounded-full pointer-events-none theme-perf-target"
  >
  </div>
</section>
<script>
  const b7 = document.getElementById("btn-7");
  const bAll = document.getElementById("btn-all");
  const w7 = document.getElementById("wrap-7");
  const wAll = document.getElementById("wrap-all");

  function toggle(showAll: boolean) {
    if (!(bAll || b7 || w7 || wAll)) return;
    if (showAll) {
      // Botones
      bAll!.className =
        "relative z-10 px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest transition-all bg-white text-black";
      b7!.className =
        "relative z-10 px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest transition-all text-gray-400 hover:text-white";
      // Wrappers
      w7!.classList.replace("opacity-100", "opacity-0");
      w7!.classList.add("translate-x-[-20px]", "pointer-events-none", "z-0");
      wAll!.classList.replace("opacity-0", "opacity-100");
      wAll!.classList.remove("translate-x-10", "pointer-events-none", "z-0");
      wAll!.classList.add("translate-x-0", "z-10");
    } else {
      b7!.className =
        "relative z-10 px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest transition-all bg-white text-black";
      bAll!.className =
        "relative z-10 px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest transition-all text-gray-400 hover:text-white";

      wAll!.classList.replace("opacity-100", "opacity-0");
      wAll!.classList.add("translate-x-10", "pointer-events-none", "z-0");
      w7!.classList.replace("opacity-0", "opacity-100");
      w7!.classList.remove("translate-x-[-20px]", "pointer-events-none", "z-0");
      w7!.classList.add("translate-x-0", "z-10");
    }
  }

  bAll?.addEventListener("click", () => toggle(true));
  b7?.addEventListener("click", () => toggle(false));
</script>
