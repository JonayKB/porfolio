<div class="z-[100] flex items-center gap-2">
    <button
        id="theme-toggle"
        class="group relative inline-flex h-10 w-10 items-center justify-center rounded-lg border border-white/10 bg-white/5 backdrop-blur-md transition-all hover:bg-white/10 active:scale-95 dark:border-white/10 dark:bg-white/5 light:border-black/10 light:bg-black/5"
        aria-label="Cambiar tema"
    >
        <svg id="sun-icon" class="absolute h-5 w-5 transition-all duration-700 opacity-0 rotate-90 text-amber-500 theme-icon-sun" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path>
        </svg>
        <svg id="moon-icon" class="absolute h-5 w-5 transition-all duration-700 opacity-0 -rotate-90 text-indigo-400 theme-icon-moon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>
</div>

<style is:global>
    :root {
        --click-x: 0px;
        --click-y: 0px;
    }

    /* --- LÓGICA DE DESVANECIMIENTO SELECTIVO --- */

    /* Clase que tú pondrás a los elementos pesados (ej. los blobs de fondo) */
    .theme-perf-target {
        transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), filter 0.5s ease !important;
        will-change: opacity, filter;
    }

    /* Cuando la transición global está activa, desvanecemos SOLO los marcados */
    .is-transitioning .theme-perf-target {
        opacity: 0 !important;
        filter: blur(0px) !important; /* Desactivar el blur quita carga a la GPU */
        pointer-events: none;
    }

    /* Configuración de View Transitions */
    ::view-transition-new(root) {
        animation: 700ms cubic-bezier(0.45, 0, 0.55, 1) both clip-path-expand;
    }

    ::view-transition-old(root) {
        animation: none;
        opacity: 1;
    }

    @keyframes clip-path-expand {
        from { clip-path: circle(0% at var(--click-x) var(--click-y)); }
        to { clip-path: circle(150% at var(--click-x) var(--click-y)); }
    }

    /* CONTROL DE ICONOS */
    .light .theme-icon-sun { opacity: 1; scale: 1; rotate: 0deg; }
    .light .theme-icon-moon { opacity: 0; scale: 0.5; rotate: -90deg; }
    .dark .theme-icon-sun { opacity: 0; scale: 0.5; rotate: 90deg; }
    .dark .theme-icon-moon { opacity: 1; scale: 1; rotate: 0deg; }
</style>

<script>
    const setupTheme = () => {
        const theme = localStorage.getItem("theme") || "dark";
        const themeToggle = document.getElementById("theme-toggle");

        const toggleClasses = (t: string) => {
            document.documentElement.classList.remove("light", "dark");
            document.documentElement.classList.add(t);
            localStorage.setItem("theme", t);
        };

        const applyTheme = async (t: string, e?: MouseEvent) => {
            const doc = document.documentElement;

            if (!e || !(document as any).startViewTransition) {
                toggleClasses(t);
                return;
            }

            // 1. Fase de Desvanecimiento (Progreso de los elementos elegidos)
            doc.classList.add("is-transitioning");

            // Esperamos a que los elementos .theme-perf-target se oculten (500ms según el CSS)
            await new Promise(resolve => setTimeout(resolve, 400));

            const x = e.clientX;
            const y = e.clientY;
            doc.style.setProperty('--click-x', `${x}px`);
            doc.style.setProperty('--click-y', `${y}px`);
            
            const transition = (document as any).startViewTransition(() => {
                toggleClasses(t);
            });

            try {
                await transition.finished;
            } finally {
                // 2. Restauración progresiva (Fade-in)
                doc.classList.remove("is-transitioning");
            }
        };

        toggleClasses(theme);

        if (themeToggle) {
            themeToggle.onclick = (e) => {
                const isDark = document.documentElement.classList.contains("dark");
                applyTheme(isDark ? "light" : "dark", e);
            };
        }
    };

    setupTheme();
    document.addEventListener("astro:after-swap", setupTheme);
</script>