<div class="z-[100] flex items-center gap-2">
    <button
        id="theme-toggle"
        class="group relative inline-flex h-10 w-10 items-center justify-center rounded-lg border border-white/10 bg-white/5 backdrop-blur-md transition-all hover:bg-white/10 active:scale-95 dark:border-white/10 dark:bg-white/5 light:border-black/10 light:bg-black/5"
        aria-label="Cambiar tema"
    >
        <svg
            id="sun-icon"
            class="absolute h-5 w-5 transition-all duration-700 opacity-0 rotate-90 text-amber-500 theme-icon-sun"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
        >
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path>
        </svg>

        <svg
            id="moon-icon"
            class="absolute h-5 w-5 transition-all duration-700 opacity-0 -rotate-90 text-indigo-400 theme-icon-moon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
        >
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>
</div>

<style is:global>
    :root {
        --click-x: 0px;
        --click-y: 0px;
    }

    /* CONTROL DE ICONOS: Evita superposición */
    /* Si es light: muestra sol, oculta luna */
    .light .theme-icon-sun {
        opacity: 1;
        scale: 1;
        rotate: 0deg;
    }
    .light .theme-icon-moon {
        opacity: 0;
        scale: 0.5;
        rotate: -90deg;
    }

    /* Si es dark: muestra luna, oculta sol */
    .dark .theme-icon-sun {
        opacity: 0;
        scale: 0.5;
        rotate: 90deg;
    }
    .dark .theme-icon-moon {
        opacity: 1;
        scale: 1;
        rotate: 0deg;
    }

    /* ANIMACIÓN PROGRESIVA (View Transitions) */
    ::view-transition-new(root) {
        /* Curva de aceleración más suave: 800ms */
        animation: 800ms cubic-bezier(0.45, 0, 0.55, 1) both clip-path-expand;
    }

    ::view-transition-old(root) {
        animation: 800ms cubic-bezier(0.45, 0, 0.55, 1) both fade-out;
    }

    @keyframes clip-path-expand {
        from { clip-path: circle(0% at var(--click-x) var(--click-y)); }
        to { clip-path: circle(150% at var(--click-x) var(--click-y)); }
    }

    @keyframes fade-out {
        from { opacity: 1; }
        to { opacity: 0; }
    }
</style>

<script>
    const setupTheme = () => {
        // Obtenemos el tema guardado o por defecto dark
        const theme = localStorage.getItem("theme") || "dark";
        const themeToggle = document.getElementById("theme-toggle");

        const toggleClasses = (t: string) => {
            if (t === "light") {
                document.documentElement.classList.remove("dark");
                document.documentElement.classList.add("light");
            } else {
                document.documentElement.classList.remove("light");
                document.documentElement.classList.add("dark");
            }
            localStorage.setItem("theme", t);
        };

        const applyTheme = (t: string, e?: MouseEvent) => {
            if (e && (document as any).startViewTransition) {
                const x = e.clientX;
                const y = e.clientY;
                document.documentElement.style.setProperty('--click-x', `${x}px`);
                document.documentElement.style.setProperty('--click-y', `${y}px`);
                
                (document as any).startViewTransition(() => {
                    toggleClasses(t);
                });
            } else {
                toggleClasses(t);
            }
        };

        // Inicializar sin animación
        toggleClasses(theme);

        themeToggle?.addEventListener("click", (e) => {
            const isDark = document.documentElement.classList.contains("dark");
            applyTheme(isDark ? "light" : "dark", e as MouseEvent);
        });
    };

    setupTheme();
    document.addEventListener("astro:after-swap", setupTheme);
</script>