---
import Base from "../layouts/Base.astro";
import Experience from "../components/Experience.astro";
import Skills from "../components/Skills.astro";
import Projects from "../components/Projects.astro";
import Start from "../components/Start.astro";
import Wakatime from "../components/Wakatime.astro";
import Contact from "../components/Contact.astro";
import Education from "../components/Education.astro";
import ScrollToTop from "../components/ScrollToTop.astro";
---

<Base>
    <main
        class="h-screen overflow-y-scroll snap-y snap-mandatory scroll-smooth bg-black text-white"
        id="scroll-root"
    >
        <Start />

        <Projects />

        <Skills />

        <Experience />

        <Education />

        <Wakatime />

        <Contact />
        <ScrollToTop />
    </main>

    <style is:global>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        h1 {
            text-wrap: balance;
        }
    </style>

    <script>
        import { languages, getLang } from "../i18n";
        // --- 1. i18n ---
        const lang = getLang();
        const t = languages[lang];
        document.querySelectorAll("[data-i18n]").forEach((el) => {
            el.textContent = t[el.dataset.i18n] ?? el.dataset.i18n;
        });

        // --- 2. Animaciones de Aparición General (Intro/Skills/Exp) ---
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove(
                            "opacity-0",
                            "translate-y-10",
                            "translate-y-12",
                        );
                    }
                });
            },
            { threshold: 0.3 },
        );
        document
            .querySelectorAll("[data-animate]")
            .forEach((el) => observer.observe(el));

        // --- 3. Parallax del Fondo (Scroll Vertical General) ---
        const root = document.getElementById("scroll-root");
        const parallaxItems = document.querySelectorAll("[data-parallax]");
        root.addEventListener("scroll", () => {
            const scrollTop = root.scrollTop;
            parallaxItems.forEach((el) => {
                const speed = Number(el.dataset.speed) || 0.2;
                el.style.transform = `translateY(${scrollTop * speed}px)`;
            });
        });
        // --- LÓGICA DE NAVEGACIÓN Y URL ---

        // 1. Manejar el scroll automático al cargar la página si hay un hash
        window.addEventListener("load", () => {
            const hash = window.location.hash;
            if (hash) {
                const targetSection = document.querySelector(hash);
                if (targetSection) {
                    targetSection.scrollIntoView({ behavior: "smooth" });
                }
            }
        });

        // 2. Observer para actualizar la URL mientras scrolleas
        const observerOptions = {
            root: null, // usa el viewport
            threshold: 0.6, // se activa cuando el 60% de la sección es visible
        };

        const urlObserver = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                // Solo actualizamos si la sección está entrando en vista
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    if (id) {
                        // Actualiza la URL sin recargar y sin saltos bruscos
                        history.replaceState(null, null, `#${id}`);
                    }
                }
            });
        }, observerOptions);

        // Aplicar el observer a todas las secciones con ID
        document.querySelectorAll("section[id]").forEach((section) => {
            urlObserver.observe(section);
        });

        // -- Navegar a hash
        console.log(window.location.hash);
        document
            .querySelector('section[id="' + window.location.hash + '"]')
            ?.scrollIntoView({ behavior: "smooth" });
    </script>
</Base>
